<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultured Diary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Example for Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <meta name="theme-color" content="#1a1a1a">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a1a">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
    <meta name="msapplication-navbutton-color" content="#1a1a1a">
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            '900': '#0a0a0a',
                            '800': '#1a1a1a',
                            '700': '#2a2a2a',
                            '600': '#3a3a3a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
body {
  background: radial-gradient(circle at 30% 20%, rgba(0, 0, 0, 0.25), transparent 60%),
              linear-gradient(145deg, #0a0a0a, #0b0b0b, #0c0c0c);
  position: relative;
  min-height: 100vh;
  overflow-x: hidden;
  z-index: 0;
}

/* Ripple dotted overlay */
body::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image: radial-gradient(rgba(255, 255, 255, 0.053) 1px, transparent 1px);
  background-size: 35px 35px;
  animation: rippleDots 12s infinite ease-in-out;
  pointer-events: none;
  z-index: 0;
  transform-origin: center;
}



        /* Glass card */
        .glass {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border-radius: 2px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: box-shadow 0.12s cubic-bezier(.4, 0, .2, 1), background 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        /* Modal appearance */
        #media-modal .glass {
            overscroll-behavior: contain;
            scroll-behavior: smooth;
            animation: modalMinimalFadeIn 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        @keyframes modalMinimalFadeIn {
            from {
                opacity: 0;
                transform: translateY(16px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Card hover */
        .card-hover {
            transition: transform 0.12s cubic-bezier(.4, 0, .2, 1), box-shadow 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
        }

        /* Navigation button */
        .nav-btn {
            transition: background 0.12s cubic-bezier(.4, 0, .2, 1), transform 0.12s cubic-bezier(.4, 0, .2, 1);
            position: relative;
        }

        .nav-btn:hover {
            transform: translateY(-1px) scale(1.04);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        /* Modal visibility */
        .modal {
            display: none;
            backdrop-filter: blur(8px);
            transition: opacity 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        .modal.active,
        .modal.flex {
            display: flex !important;
            opacity: 1;
            animation: fadeIn 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        /* Fade animation */
        .animate-fade-in {
            animation: fadeIn 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Toast animation */
        #toast-msg {
            transition: opacity 0.12s cubic-bezier(.4, 0, .2, 1), transform 0.12s cubic-bezier(.4, 0, .2, 1);
            will-change: opacity, transform;
        }

        /* Username box */
        #username-edit-box {
            background: rgba(22, 22, 22, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            transition: opacity 0.12s cubic-bezier(.4, 0, .2, 1), transform 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        /* Button transitions */
        button,
        .btn,
        .rounded-lg,
        .rounded-md {
            transition: background 0.12s cubic-bezier(.4, 0, .2, 1), color 0.12s cubic-bezier(.4, 0, .2, 1), border 0.12s cubic-bezier(.4, 0, .2, 1), box-shadow 0.12s cubic-bezier(.4, 0, .2, 1), transform 0.12s cubic-bezier(.4, 0, .2, 1);
        }

        /* Hide scrollbars */
        .scroll-hidden {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scroll-hidden::-webkit-scrollbar {
            display: none;
        }

        select option {
            background-color: #111827;
            /* Dark blue/gray */
            color: #ffffff;
        }

        #username-edit-box {
            background: rgba(22, 22, 22, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
        }
    </style>
</head>

<body class="bg-dark-900 min-h-screen text-white pb-16"> 
<!-- Navbar -->
<nav class="glass fixed bottom-0 left-0 right-0 z-40 border-t border-white/10 md:sticky md:top-0 md:border-b md:border-t-0">
  <div class="container mx-auto px-4 py-2">
    <div class="flex justify-between items-center">
      <!-- Logo / Title -->
      <h1 onclick="showPage('home')"
          class="text-2xl gradient-text flex items-center gap-2 mr-4 cursor-pointer hover:underline transition-all duration-150 hidden md:flex">
        <span class="text-2xl"></span>
        Cultured Diary
      </h1>

      <!-- 🧭 Icon-Based Navigation -->
      <div class="flex justify-around w-full md:w-auto gap-4 items-center text-white">
        <button onclick="showPage('home')" id="home-btn"
                class="p-2 rounded-md hover:bg-white/10 transition-colors duration-150"
                aria-label="Home">
          <i data-lucide="home" class="w-6 h-6"></i>
        </button>
        <button onclick="showPage('search')" id="search-btn"
                class="p-2 rounded-md hover:bg-white/10 transition-colors duration-150"
                aria-label="Search">
          <i data-lucide="search" class="w-6 h-6"></i>
        </button>
        <button onclick="showPage('diary')" id="diary-btn"
                class="p-2 rounded-md hover:bg-white/10 transition-colors duration-150"
                aria-label="Diary">
          <i data-lucide="book-open" class="w-6 h-6"></i>
        </button>
        <button onclick="showPage('watchlist')" id="watchlist-btn"
                class="p-2 rounded-md hover:bg-white/10 transition-colors duration-150"
                aria-label="Watchlist">
          <i data-lucide="bookmark" class="w-6 h-6"></i>
        </button>
        <button onclick="showPage('profile')" id="profile-btn"
                class="p-2 rounded-md hover:bg-white/10 transition-colors duration-150"
                aria-label="Profile">
          <i data-lucide="user" class="w-6 h-6"></i>
        </button>
      </div>
    </div>
  </div>
</nav>

    <!-- Home Page -->
    <!-- Full-Width Hero Banner -->
    <div id="home-page" class="page container mx-auto p-4 pt-12 animate-fade-in">
        <!-- Hero Banner -->
        <!-- Hero Banner with Centered Outlined Button -->
        <section class="w-full text-center pt-4 pb-4 px-4">
            <h1 class="text-4xl md:text-5xl font-light text-white mb-3 leading-tight">
                Keep track of what you watch — from anime to cinema.
            </h1>
            <p class="text-lg text-gray-300 font-light mb-4">
                Your personal diary for movies, shows, and anime.
            </p>
            <button onclick="showPage('search')"
                class="border border-white text-white px-6 py-2 rounded-md text-lg hover:bg-white hover:text-black transition duration-300 mb-6">
                Get Started
            </button>
        </section>


<!-- 🕘 Recently Watched -->
<div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-bold gradient-text">Recently Watched</h2>
  <button onclick="showPage('diary')" class="text-blue-400 hover:text-blue-300 text-sm underline">
    See More
  </button>
</div>
<div id="recent-watched" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 py-4"></div>

<!-- 🎯 Watchlist Preview -->
<div class="flex items-center justify-between mb-4 mt-8">
  <h2 class="text-xl font-bold gradient-text">My Watchlist</h2>
  <button onclick="showPage('watchlist')" class="text-blue-400 hover:text-blue-300 text-sm underline">
    See More
  </button>
</div>


<!-- Home Stats Rectangles (Total Watched) -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <!-- Movies Watched -->
    <div class="glass rounded-xl p-4 text-center card-hover cursor-pointer"
        onclick="goToDiaryWithFilter('movie')">
        <div class="text-xl font-bold text-white" id="home-movies-watched">0</div>
        <div class="text-gray-400 text-lg">Movies Watched</div>
    </div>

    <!-- Series Watched -->
    <div class="glass rounded-xl p-4 text-center card-hover cursor-pointer"
        onclick="goToDiaryWithFilter('series')">
        <div class="text-xl font-bold text-white" id="home-series-watched">0</div>
        <div class="text-gray-400 text-lg">Shows Watched</div>
    </div>

    <!-- Anime Watched -->
    <div class="glass rounded-xl p-4 text-center card-hover cursor-pointer"
        onclick="goToDiaryWithFilter('anime')">
        <div class="text-xl font-bold text-white" id="home-anime-watched">0</div>
        <div class="text-gray-400 text-lg">Anime Watched</div>
    </div>

    <!-- In Watchlist -->
    <div onclick="showPage('watchlist')" class="glass rounded-xl p-4 text-center card-hover cursor-pointer">
        <div class="text-xl font-bold text-white" id="home-watchlist-count">0</div>
        <div class="text-gray-400 text-lg">In Watchlist</div>
    </div>
</div>


       

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass rounded-xl p-6 card-hover cursor-pointer" onclick="showPage('search')">
                <div class="text-center">
                    <div class="text-4xl mb-2"></div>
                    <h3 class="text-lg font-bold mb-2">Discover</h3>
                    <p class="text-gray-400 text-lg">Find your next favorite</p>
                </div>
            </div>
            <div class="glass rounded-xl p-6 card-hover cursor-pointer" onclick="showPage('watchlist')">
                <div class="text-center">
                    <div class="text-4xl mb-2"></div>
                    <h3 class="text-lg font-bold mb-2">Watchlist</h3>
                    <p class="text-gray-400 text-lg">Your saved content</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Page -->
    <div id="search-page" class="page hidden container mx-auto p-4 animate-fade-in">
            <h2 class="text-xl font-bold mb-4 text-white">Discover...</h2>
            <div class="flex flex-col md:flex-row gap-2 mb-4">
                <input type="text" id="search-input" placeholder="Search movies, series, or anime..." class="flex-1 px-4 py-2.5 bg-white/5 border border-white/10 text-white
placeholder-gray-400 text-base sm:text-lg rounded-lg
focus:outline-none focus:ring-2 focus:ring-white/20
backdrop-blur-sm shadow-sm transition duration-150">


                <button onclick="searchMedia()" class="px-5 py-2.5 rounded-lg bg-white/5 text-white border border-white/10
hover:bg-white/10 hover:text-white hover:border-white/20
transition-all duration-300 text-base sm:text-lg font-medium
backdrop-blur-sm shadow-sm">
                    Search
                </button>


            </div>

            <div class="flex gap-4">
                <label class="flex items-center text-gray-300">
                    <input type="checkbox" id="search-movies" checked class="mr-2 accent-purple-600">
                    Movies/Series
                </label>
                <label class="flex items-center text-gray-300">
                    <input type="checkbox" id="search-anime" checked class="mr-2 accent-purple-600">
                    Anime
                </label>
            </div>
       
        <div id="search-results" class="flex flex-col"></div>
    </div>

    <!-- Diary Page -->
    <div id="diary-page" class="page hidden container mx-auto p-4 animate-fade-in">
            <h2 class="text-xl font-bold gradient-text py-3">My Diary</h2>
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <select id="diary-filter" onchange="filterDiary()"
                    class="p-3 text-white border border-white/20 rounded-lg bg-white/5 focus:outline-none focus:ring-2 focus:ring-white w-full md:w-auto backdrop-blur-sm"
                    title="Filter diary entries by media type">
                    <option value="all">All Media</option>
                    <option value="movie">Movies</option>
                    <option value="series">Series</option>
                    <option value="anime">Anime</option>
                    <option value="favorite">Favorites</option>
                </select>
                <button type="button" onclick="showPage('search')"
                    class="px-6 py-3 border border-white/20 text-white bg-white/5 hover:bg-white/10 rounded-lg text-base font-medium transition-all w-full md:w-auto">
                    Discover More Content
                </button>
            </div>
        
        <div id="diary-entries" class="flex flex-col"></div>
    </div>


   <!-- Watchlist Page -->
<div id="watchlist-page" class="page hidden container mx-auto p-4 animate-fade-in">
  <!-- Header row with margin-bottom -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
    <h2 class="text-xl font-bold gradient-text">My Watchlist</h2>
    <button onclick="showPage('search')"
      class="px-3 py-2 border border-white/20 text-white bg-white/5 hover:bg-white/10 rounded-md text-sm font-medium transition-all w-full md:w-auto">
      Browse More
    </button>
  </div>

  <!-- Watchlist List Section -->
  <div id="watchlist-items" class="flex flex-col"></div>
</div>


    <!-- Profile Page -->
    <div id="profile-page" class="page hidden container mx-auto p-4 animate-fade-in">
        <div class=" p-6 space-y-6">
            <h2 class="text-xl font-bold gradient-text">Profile</h2>
            <div class="flex flex-col md:flex-row items-center gap-6">
                <!-- Avatar Upload -->
                <label for="avatar-upload"
                    class="w-24 h-24 overflow-hidden rounded-xl bg-white/10 border border-white/10 shadow-inner relative cursor-pointer group">
                    <img id="profile-avatar" src="https://i.imgur.com/1XjXgJL.png" alt="Avatar"
                        class="w-full h-full object-cover" />
                    <input type="file" id="avatar-upload" accept="image/*" class="hidden" />
                    <div
                        class="absolute inset-0 bg-black/40 text-white text-xs items-center justify-center hidden group-hover:flex">
                        Change
                    </div>
                </label>
                <!-- Profile Info -->
                <div class="text-white text-base space-y-2 flex-1">
                    <p class="flex items-center gap-2">
                      
                        <strong><span id="profile-username" class="cursor-pointer hover:underline text-white/90"
                            onclick="toggleUsernameEdit()">
                            Guest
                        </span></strong>
                    </p>
                    <p><strong>Entries Logged:</strong> <span id="profile-total-entries">0</span></p>
                    <p><strong>Reviews Written:</strong> <span id="profile-total-reviews">0</span></p>

                    <!-- Watched stats as plain lines, bold label, value after colon -->
                    <div class="space-y-1 mt-4">
                        <p><strong>Watched This Month:</strong> <span id="profile-this-month">0</span></p>
                        <p><strong>Watched This Year:</strong> <span id="profile-this-year">0</span></p>
                    </div>

                    <!-- Badges -->
                    <div id="profile-badges" class="flex flex-wrap gap-2 pt-2">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
           
            <!-- Username Edit Box -->
            <div id="username-edit-box"
                class="absolute top-[25%] left-1/2 transform -translate-x-1/2 z-50 p-6 hidden fade-zoom text-white w-full max-w-xs rounded-2xl backdrop-blur-md bg-white/5 border border-white/10 shadow-xl">

                <h3 class="font-semibold text-xl mb-3 text-white/90">Edit Username</h3>

                <input id="username-input" type="text" placeholder="Enter new username"
                    class="bg-white/10 text-white placeholder-white/40 px-4 py-2 rounded-lg w-full outline-none focus:ring-2 focus:ring-blue-400 transition" />

                <button onclick="saveUsername()"
                    class="mt-4 bg-dark-700 hover:to-blue-600 text-white px-4 py-2 rounded-lg w-full transition-all font-medium">
                    Save
                </button>
            </div>

        </div>
    </div>


    <!-- Media Detail Page -->
    <div id="media-page" class="page hidden min-h-screen p-6 text-white">
        <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-8">
            <!-- Poster -->
            <div class="w-full lg:w-1/4 flex-shrink-0">
                <img id="media-poster" src="" alt=""
                    class="w-full h-auto object-cover rounded-xl shadow-lg bg-dark-700">
            </div>

            <!-- Info -->
            <div class="w-full lg:w-2/3 space-y-4">
                <!-- Header Row -->
                <div class="flex items-start justify-between">
                    <button onclick="backFromMediaDetail()"
                        class="text-gray-400 hover:text-white flex items-center gap-1 text-sm mb-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                    </button>
                </div>

                <!-- Title -->
                <h1 id="media-title" class="text-3xl font-bold text-white leading-tight"></h1>
                <p id="media-year" class="text-gray-400 text-sm font-medium"></p>
                <p id="media-genre" class="text-sm text-gray-300"></p>
                <p id="media-plot" class="text-gray-200 text-base leading-relaxed"></p>

                <!-- Extra Info -->
                <div id="media-extra-info"
                    class="grid grid-cols-1 md:grid-cols-2 gap-y-2 gap-x-6 text-sm text-white/80 pt-4 border-t border-white/10">
                    <!-- filled dynamically -->
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 pt-4">
                    <button onclick="addToWatchlist()"
                        class="px-6 py-2 rounded-md bg-gray-800 hover:bg-gray-700 text-white font-medium transition">
                        Add to Watchlist
                    </button>
                    <button onclick="markAsWatched()"
                        class="px-6 py-2 rounded-md bg-gray-800 hover:bg-gray-700 text-white font-semibold transition">
                        Add to Diary
                    </button>
                </div>
            </div>
        </div>

        <!-- Rating & Review Section -->
        <div class="max-w-4xl mx-auto mt-10 border-t border-white/10 pt-6">
            <h2 class="text-xl font-semibold text-white mb-4">Review or Log</h2>


            <!-- Review -->
            <textarea id="review-text" rows="3" placeholder="Write a review..."
                class="w-full p-3 bg-gray-800 border border-white/20 rounded-lg text-white mb-4 resize-none"></textarea>
            <div class="mb-4">
                <label for="watch-status" class="text-sm mb-1 text-white/80 block">Status</label>
                <select id="watch-status" class="p-3 bg-gray-800 border border-white/20 rounded-lg text-white w-full">
                    <option value="watching">Watching</option>
                    <option value="completed">Completed</option>
                    <option value="on-hold">On-Hold</option>
                    <option value="dropped">Dropped</option>
                    <option value="rewatch">Rewatch</option>
                </select>
            </div>

            <!-- Add Season selector for series -->
            <div id="season-select-row" class="mb-4 hidden">
                <label for="season-number" class="text-sm mb-1 text-white/80 block">Season</label>
                <select id="season-number"
                    class="p-3 bg-gray-800 border border-white/20 rounded-lg text-white w-full"></select>
            </div>

            <!-- Watch Date, Season, Episode -->
            <!-- For Series/Anime -->
            <div id="range-dates" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
                <div class="flex flex-col">
                    <label for="start-date" class="text-sm mb-1 text-white/80">Started On</label>
                    <input type="date" id="start-date"
                        class="p-3 bg-gray-800 border border-white/20 rounded-lg text-white w-full">
                </div>
                <div class="flex flex-col">
                    <label for="finish-date" class="text-sm mb-1 text-white/80">Finished On</label>
                    <input type="date" id="finish-date"
                        class="p-3 bg-gray-800 border border-white/20 rounded-lg text-white w-full">
                </div>
            </div>

            <!-- For Movies -->
            <div id="single-date" class="mb-4">
                <label for="watch-date" class="text-sm mb-1 text-white/80">Watched On</label>
                <input type="date" id="watch-date"
                    class="p-3 bg-gray-800 border border-white/20 rounded-lg text-white w-full">
            </div>


            <div class="flex gap-4">
                <button onclick="saveDiaryEntry()"
                    class="bg-gray-700 hover:bg-gray-800 text-white px-6 py-3 rounded-lg font-medium flex-1">
                    Save to Diary
                </button>
                <button onclick="clearRating()" class="bg-gray-700 hover:bg-gray-800 text-white px-6 py-3 rounded-lg">
                    Clear
                </button>
            </div>
        </div>
    </div>



    <script>
        // Global state
        let currentMedia = null;
        let diaryData = {}; // Global store for entries
        let editingEntryId = null;
        let editingEntryTimestamp = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            showPage('home');
            document.getElementById('home-btn').classList.add('active'); // Ensure Home is active on load
            updateAllStats();
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchMedia();
            });
            document.querySelectorAll('#rating-stars .star').forEach(star => {
                star.addEventListener('click', (e) => {
                    currentRating = parseInt(e.target.dataset.rating);
                    updateStars();
                });
                star.addEventListener('mouseenter', () => highlightStars(starIndex));
                star.addEventListener('mouseleave', updateStars);
                loadWatchlistPreview();

            });
            history.replaceState(null, '', location.href);

            // Debounce search input
            const searchInput = document.getElementById('search-input');
            searchInput.removeEventListener('input', window._debouncedSearchMedia || (() => { }));
            window._debouncedSearchMedia = debounce(searchMedia, 300);
            searchInput.addEventListener('input', window._debouncedSearchMedia);
        });
        window.addEventListener('popstate', handleBackNavigation);

        function handleBackNavigation() {
            if (document.getElementById('review-modal')?.classList.contains('flex')) {
                closeReviewModal();
                return;
            }
            if (document.getElementById('media-modal')?.classList.contains('active')) {
                closeModal();
                return;
            }
            if (document.getElementById('rating-modal')?.classList.contains('active')) {
                closeRatingModal();
                return;
            }
            if (document.getElementById('edit-diary-modal')?.classList.contains('active')) {
                closeEditModal();
                return;
            }
            const homeVisible = !document.getElementById('home-page').classList.contains('hidden');
            if (!homeVisible) {
                showPage('home');
                history.pushState(null, '', location.href);
            } else {
                history.go(-1);
            }
        }

        function goToDiaryWithFilter(type) {
            showPage('diary');
            document.getElementById('diary-filter').value = type;
            filterDiary();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId + '-btn').classList.add('active');
            if (pageId !== 'home') {
                history.pushState(null, '', location.href);
            }
            if (pageId === 'home') loadHome();
            if (pageId === 'diary') {
                document.getElementById('diary-filter').value = 'all';
                window.scrollTo({ top: 0, behavior: 'smooth' });

                loadDiary();
            }
            if (pageId === 'watchlist') loadWatchlist();
            if (pageId === 'profile') setTimeout(updateProfile, 50);
        }

        function loadHome() {
            updateAllStats();
            loadRecentWatched();
            loadWatchlistPreview();

        }

        function getWatchDate(entry) {
  if (entry.Type === 'series' || entry.Type === 'anime') {
    if (entry.finishDate) return new Date(entry.finishDate);
    if (entry.startDate) return new Date(entry.startDate);
  }
  if (entry.dateWatched) return new Date(entry.dateWatched);
  return new Date(0); // fallback
}

function loadRecentWatched() {
  const container = document.getElementById('recent-watched');
  if (!container) return;

  const diary = JSON.parse(localStorage.getItem('diary') || '[]');
  const validEntries = diary.filter(e => e && e.Title && e.imdbID && e.dateAdded);

  if (validEntries.length === 0) {
    container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">No recent watches. Start exploring!</div>';
    return;
  }

  // Sort using unified watch date
  validEntries.sort((a, b) => getWatchDate(b) - getWatchDate(a));

  const recent = validEntries.slice(0, 6); // Show top 6 most recently watched
  diaryData = {};

  container.innerHTML = recent.map(entry => {
    const key = entry.imdbID + entry.dateAdded;
    diaryData[key] = entry;

    let watchedOn = 'Unknown';
    if (entry.Type === 'series' || entry.Type === 'anime') {
      const start = entry.startDate ? new Date(entry.startDate).toLocaleDateString() : null;
      const finish = entry.finishDate ? new Date(entry.finishDate).toLocaleDateString() : null;
      if (start && finish) watchedOn = `Finished: ${start} → ${finish}`;
      else if (start) watchedOn = `Started: ${start}`;
      else if (finish) watchedOn = `Finished: ${finish}`;
    } else if (entry.dateWatched) {
      watchedOn = `Watched on: ${new Date(entry.dateWatched).toLocaleDateString()}`;
    }

    /// ✅ Season display (only for series/anime)
let seasonText = '';
if (entry.Type === 'series' || entry.Type === 'anime') {
  const season = entry.Season || entry.season || entry.seasonNumber; 
  if (season) {
    seasonText = `<div class="text-blue-400 text-xs">Season ${season}</div>`;
  }
}

    return `
      <div class="cursor-pointer card-hover" onclick="openReviewPage('${entry.imdbID}', '${entry.dateAdded}')">
        <img src="${entry.Poster && entry.Poster !== 'N/A' ? entry.Poster : 'https://via.placeholder.com/160x240?text=No+Image'}"
             alt="${entry.Title}"
             class="rounded-lg w-full h-64 object-contain mb-2 shadow-md bg-black/30" />
        <h4 class="text-sm font-semibold truncate text-white">${entry.Title}</h4>
        ${seasonText}
        <div class="text-gray-400 text-xs truncate">${watchedOn}</div>
      </div>
      
    `;
    
  }).join('');
}

        function updateAllStats() {
            const diary = JSON.parse(localStorage.getItem('diary') || '[]');
            const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
            const movieCount = diary.filter(e => e.Type === 'movie').length;
            const seriesCount = diary.filter(e => e.Type === 'series').length;
            const animeCount = diary.filter(e => e.Type === 'anime').length;
            document.getElementById('home-movies-watched').textContent = movieCount;
            document.getElementById('home-series-watched').textContent = seriesCount;
            document.getElementById('home-anime-watched').textContent = animeCount;
            document.getElementById('home-watchlist-count').textContent = watchlist.length;
            // Removed: update home-this-month, home-last-month, home-this-year, home-last-year
        }
        // Debounce utility
        function debounce(fn, delay) {
            let timer = null;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

// ================= SEARCH FUNCTION =================
async function searchMedia() {
    const query = document.getElementById('search-input').value.trim();
    if (!query) return;

    const searchMovies = document.getElementById('search-movies').checked;
    const searchAnime = document.getElementById('search-anime').checked;
    const container = document.getElementById('search-results');

    // Clear and show loading state
    container.innerHTML = `
        <div class="col-span-full text-center text-gray-400 py-8 animate-pulse">
            <span class="inline-block w-6 h-6 border-2 border-t-transparent border-white rounded-full animate-spin mr-2"></span>
            Searching...
        </div>
    `;

    const movieResults = [];
    const animeResults = [];
    const fetchTasks = [];

    // ================= FETCH MOVIES & SERIES (OMDB) =================
    if (searchMovies) {
        for (let page = 1; page <= 2; page++) { // fetch up to 20 results
            fetchTasks.push(
                fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(query)}&apikey=1dcec97d&page=${page}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.Search) {
                            data.Search.forEach(item => {
                                movieResults.push({
                                    Title: item.Title,
                                    Year: item.Year,
                                    Poster: (!item.Poster || item.Poster === "N/A")
                                        ? "https://via.placeholder.com/80x120?text=No+Image"
                                        : item.Poster,
                                    imdbID: item.imdbID,
                                    type: item.Type, // "movie" or "series"
                                    source: "omdb",
                                    imdbRating: "N/A" // detail rating will be fetched later
                                });
                            });
                        }
                    })
                    .catch(err => console.error("OMDB fetch error:", err))
            );
        }
    }

    // ================= FETCH ANIME (JIKAN) =================
    if (searchAnime) {
        fetchTasks.push(
            fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(query)}&limit=5`)
                .then(res => res.json())
                .then(data => {
                    if (data.data) {
                        animeResults.push(...data.data.map(item => ({
                            Title: item.title,
                            Year: item.aired?.from ? new Date(item.aired.from).getFullYear() : "N/A",
                            Poster: item.images?.jpg?.image_url || "https://via.placeholder.com/80x120?text=No+Image",
                            imdbID: item.mal_id.toString(),
                            type: "anime",
                            source: "jikan",
                            Plot: item.synopsis || "",
                            Genre: item.genres?.map(g => g.name).join(", ") || "N/A",
                            imdbRating: item.score?.toFixed(1) || "N/A",
                            episodes: item.episodes || "N/A"
                        })));
                    }
                })
                .catch(err => console.error("Jikan fetch error:", err))
        );
    }

    try {
        await Promise.all(fetchTasks);
        displaySearchResults(movieResults, animeResults);
    } catch (error) {
        console.error("Search error:", error);
        container.innerHTML = `
            <div class="col-span-full text-center text-red-400 py-8">
                Search failed. Please try again later.
            </div>
        `;
    }
}

// ================= DISPLAY RESULTS =================
function displaySearchResults(movieResults, animeResults) {
    const container = document.getElementById('search-results');
    container.innerHTML = "";

    // 🎬 Movies/Series Section
    if (movieResults.length) {
container.innerHTML += `<h2 class="text-xl font-bold text-white mb-2 pt-6">Movies & Series</h2>`;
        container.innerHTML += movieResults.map((item, idx) => `
            <div class="flex items-center gap-4 px-2 py-4 cursor-pointer hover:bg-white/5 rounded transition"
                 onclick="showMediaDetail('${item.imdbID}', '${item.source}')">
                <img src="${item.Poster}" alt="${item.Title}"
                     class="w-20 h-28 object-contain bg-black/30 rounded-md flex-shrink-0">
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-lg mb-1 truncate text-white">${item.Title}</h3>
                    <div class="text-gray-400 text-sm mb-1">${item.Year} • ${item.type}</div>
                    <div class="text-yellow-400 text-sm mb-1">★ ${item.imdbRating}</div>
                </div>
            </div>
            ${idx < movieResults.length - 1 ? '<hr class="border-white/10 mx-2">' : ''}
        `).join('');
    }

    // 🎌 Anime Section
    if (animeResults.length) {
        container.innerHTML += `<h2 class="text-xl font-bold text-white mt-6 mb-2">Anime</h2>`;
        container.innerHTML += animeResults.map((item, idx) => `
            <div class="flex items-center gap-4 px-2 py-4 cursor-pointer hover:bg-white/5 rounded transition"
                 onclick="showMediaDetail('${item.imdbID}', '${item.source}')">
                <img src="${item.Poster}" alt="${item.Title}"
                     class="w-20 h-28 object-contain bg-black/30 rounded-md flex-shrink-0">
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-lg mb-1 truncate text-white">${item.Title}</h3>
                    <div class="text-gray-400 text-sm mb-1">${item.Year} • ${item.type}</div>
                    <div class="text-yellow-400 text-sm mb-1">★ ${item.imdbRating}</div>
                    ${item.Genre ? `<div class="text-gray-500 text-xs mb-1 truncate">${item.Genre}</div>` : ""}
                    ${item.Plot ? `<div class="text-gray-300 text-xs line-clamp-2">${item.Plot}</div>` : ""}
                    ${item.episodes ? `<div class="text-purple-400 text-xs mb-1">Episodes: ${item.episodes}</div>` : ""}
                </div>
            </div>
            ${idx < animeResults.length - 1 ? '<hr class="border-white/10 mx-2">' : ''}
        `).join('');
    }

    // Nothing found
    if (!movieResults.length && !animeResults.length) {
        container.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                No results found.
            </div>
        `;
    }
}

// ================== ENTER KEY SUPPORT ==================
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("search-input");
    if (searchInput) {
        searchInput.addEventListener("keydown", e => {
            if (e.key === "Enter") searchMedia();
        });
    }
});

        // Media detail functionality
        async function showMediaDetail(id, source) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById('media-page').classList.remove('hidden');

            try {
                let mediaData;
                if (source === 'omdb') {
const response = await fetch(`https://www.omdbapi.com/?i=${id}&apikey=1dcec97d`);
                    mediaData = await response.json();
                    if (mediaData.Type === 'series') {
                        mediaData.seasons = mediaData.totalSeasons || 'N/A';
                    }
                } else {
                    const response = await fetch(`https://api.jikan.moe/v4/anime/${id}`);
                    const data = await response.json();
                    const item = data.data;
                    mediaData = {
                        Title: item.title,
                        Year: item.aired?.from ? new Date(item.aired.from).getFullYear() : 'N/A',
                        Poster: item.images?.jpg?.image_url || '',
                        Plot: item.synopsis,
                        Genre: item.genres?.map(g => g.name).join(', ') || 'N/A',
                        imdbRating: item.score || 'N/A',
                        Type: 'anime',
                        imdbID: id,
                        episodes: item.episodes || 'N/A'
                    };
                }

                currentMedia = { ...mediaData, source };
                document.getElementById('media-title').textContent = mediaData.Title;
                document.getElementById('media-year').textContent = `${mediaData.Year} • ${mediaData.Type || 'anime'}`;
                document.getElementById('media-genre').textContent = mediaData.Genre;
                document.getElementById('media-plot').textContent = mediaData.Plot || 'No description available.';

                let extraInfoHTML = '';
                if (source === 'omdb') {
                    extraInfoHTML = `
<p><strong>Runtime:</strong> ${mediaData.Runtime || 'N/A'}</p>
<p><strong>Rated:</strong> ${mediaData.Rated || 'N/A'}</p>
<p><strong>Language:</strong> ${mediaData.Language || 'N/A'}</p>
<p><strong>Country:</strong> ${mediaData.Country || 'N/A'}</p>
<p><strong>Actors:</strong> ${mediaData.Actors || 'N/A'}</p>
<p><strong>IMDb:</strong> ★ ${mediaData.imdbRating || 'N/A'} (${mediaData.imdbVotes || '0'} votes)</p>
${mediaData.Type === 'series' ? `<p><strong>Seasons:</strong> ${mediaData.seasons || 'N/A'}</p>` : ''}
`;
                } else {
                    extraInfoHTML = `
${mediaData.episodes ? `<p><strong>Episodes:</strong> ${mediaData.episodes}</p>` : ''}
`;
                }
                document.getElementById('media-extra-info').innerHTML = extraInfoHTML;

                document.getElementById('media-poster').src =
                    mediaData.Poster !== 'N/A' ? mediaData.Poster : 'https://via.placeholder.com/300x450?text=No+Image';

                // 🔽 SHOW/HIDE start/finish date fields
                const isSeriesOrAnime = mediaData.Type === 'series' || mediaData.Type === 'anime';
                document.getElementById('range-dates').classList.toggle('hidden', !isSeriesOrAnime);
                document.getElementById('single-date').classList.toggle('hidden', isSeriesOrAnime);

                // Show/hide season selector for series
                const seasonRow = document.getElementById('season-select-row');
                const seasonSelect = document.getElementById('season-number');
                if (mediaData.Type === 'series' && Number(mediaData.seasons) > 1) {
                    seasonRow.classList.remove('hidden');
                    seasonSelect.innerHTML = '';
                    for (let i = 1; i <= Number(mediaData.seasons); i++) {
                        seasonSelect.innerHTML += `<option value="${i}">Season ${i}</option>`;
                    }
                } else if (mediaData.Type === 'series') {
                    seasonRow.classList.remove('hidden');
                    seasonSelect.innerHTML = `<option value="1">Season 1</option>`;
                } else {
                    seasonRow.classList.add('hidden');
                    seasonSelect.innerHTML = '';
                }


            } catch (error) {
                console.error('Error loading media details:', error);
            }

            history.pushState({ page: 'media' }, '', location.href);
        }


        function backFromMediaDetail() {
            showPage('search');
        }

        function closeModal() {
            document.getElementById('media-modal').classList.remove('active');
        }

        // Watchlist functionality
        function addToWatchlist() {
            if (!currentMedia) return;

            let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');

            if (!watchlist.find(item => item.imdbID === currentMedia.imdbID)) {
                watchlist.push(currentMedia);
                localStorage.setItem('watchlist', JSON.stringify(watchlist));

                updateAllStats();
                showToast("Added to watchlist"); // ✅ show only on success
            } else {
                showToast("Already in watchlist "); // ⚠ optional toast instead of alert
                // Optionally remove the old alert line
                // alert('Already in watchlist!');
            }

            closeModal(); // optional, based on your flow
        }


function loadWatchlist() {
  const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
  const container = document.getElementById('watchlist-items');

  if (watchlist.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-400 py-8">Your watchlist is empty.</div>';
    return;
  }

  container.className = 'flex flex-col'; // List style layout

  container.innerHTML = watchlist.map((item, idx) => `
    <div class="flex items-center gap-4 px-2 py-4 hover:bg-white/5 rounded transition cursor-pointer"
         onclick="showMediaDetail('${item.imdbID}', '${item.source || 'omdb'}')">

      <!-- Poster -->
      <img src="${item.Poster !== 'N/A' ? item.Poster : 'https://via.placeholder.com/80x120?text=No+Image'}"
           alt="${item.Title}"
           class="w-24 h-36 object-cover rounded-md shadow-md bg-black/20 flex-shrink-0">

      <!-- Media Info -->
      <div class="flex-1 min-w-0">
        <h3 class="text-white text-lg font-medium truncate">${item.Title}</h3>
        <p class="text-white text-sm font-light">${item.Year} </p>
      </div>

      <!-- Remove Button -->
      <div class="ml-auto">
        <button onclick="event.stopPropagation(); removeFromWatchlist('${item.imdbID}')"
                class="text-red-400 hover:text-red-300 text-sm font-medium">Remove</button>
      </div>
    </div>
    ${idx < watchlist.length - 1 ? '<hr class="border-white/10 mx-2">' : ''}
  `).join('');
}
       function loadWatchlistPreview() {
  const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
  const container = document.getElementById('watchlist-preview');
  if (!container) return;

  if (watchlist.length === 0) {
    container.innerHTML = '<div class="text-gray-400 col-span-full text-center">No items in your watchlist yet.</div>';
  }

  const limitedItems = watchlist.slice(0, 6); // Show first 6 only
  container.innerHTML = limitedItems.map(item => `
    <div class="cursor-pointer" onclick="showMediaDetail('${item.imdbID}', '${item.source || 'omdb'}')">
        <img src="${item.Poster && item.Poster !== 'N/A' ? item.Poster : 'https://via.placeholder.com/...'}"
        class="w-full h-64 object-contain mb-2 shadow-md bg-black/30 rounded-md">
    </div>
  `).join('');
}
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        function removeFromWatchlist(id) {
            let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
            watchlist = watchlist.filter(item => item.imdbID !== id);
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            loadWatchlist();
            updateAllStats();
        }
        function markAsWatchedFromList(id) {
            const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
            const media = watchlist.find(item => item.imdbID === id);
            if (media) {
                currentMedia = media;
                currentRating = 0;
                updateStars();

                showMediaDetail(id, media.source || 'omdb'); // showMediaDetail should already populate page
                setTimeout(() => {
                    const ratingSection = document.getElementById('rating-stars');
                    if (ratingSection) {
                        ratingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300); // wait for media page to render
            }
        }
        function markAsWatched() {
            if (!currentMedia) return;

            currentRating = 0;
            updateStars();

            const ratingSection = document.getElementById('rating-stars');
            if (ratingSection) {
                ratingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }



        function saveDiaryEntry() {
    if (!currentMedia) return;

    const diary = JSON.parse(localStorage.getItem('diary') || '[]');
    showToast("Added to diary ✅");

    const isSeriesOrAnime = currentMedia.Type === 'series' || currentMedia.Type === 'anime';

    let selectedSeason = null;
    if (currentMedia.Type === 'series') {
        const seasonSelect = document.getElementById('season-number');
        selectedSeason = seasonSelect && seasonSelect.value ? parseInt(seasonSelect.value) : null;
    }

    const entry = {
        ...currentMedia,
        rating: typeof currentRating !== "undefined" ? currentRating : null,
        review: document.getElementById('review-text').value || null,
        status: document.getElementById('watch-status')?.value || 'completed',
        dateWatched: !isSeriesOrAnime ? (document.getElementById('watch-date')?.value || null) : null,
        startDate: isSeriesOrAnime ? (document.getElementById('start-date')?.value || null) : null,
        finishDate: isSeriesOrAnime ? (document.getElementById('finish-date')?.value || null) : null,
        dateAdded: new Date().toISOString(),
        season: selectedSeason,
        episode: parseInt(document.getElementById('episode-number')?.value) || null,
        episodes: currentMedia.episodes || null
    };

    const allowDuplicate = entry.status === 'rewatch';

    if (!allowDuplicate) {
        const existingIndex = diary.findIndex(e =>
            e.imdbID === entry.imdbID &&
            e.status !== 'rewatch' &&
            (!isSeriesOrAnime || e.season === entry.season)
        );

        if (existingIndex !== -1) {
            entry.dateAdded = diary[existingIndex].dateAdded;
            diary[existingIndex] = entry;
        } else {
            diary.unshift(entry);
        }
    } else {
        diary.unshift(entry);
    }

    localStorage.setItem('diary', JSON.stringify(diary));

    let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
    watchlist = watchlist.filter(item => item.imdbID !== currentMedia.imdbID);
    localStorage.setItem('watchlist', JSON.stringify(watchlist));

    closeRatingModal();
    updateAllStats();
    loadDiary();
    updateProfile && updateProfile();
}

function closeRatingModal() {
    document.getElementById('rating-modal').classList.remove('active');
    document.getElementById('review-text').value = '';
    currentRating = 0;
    updateStars();
}

function getWatchDate(entry) {
    if (entry.Type === 'series' || entry.Type === 'anime') {
        return entry.finishDate ? new Date(entry.finishDate)
            : entry.startDate ? new Date(entry.startDate)
                : new Date(0);
    }
    return entry.dateWatched ? new Date(entry.dateWatched) : new Date(0);
}

function addToDiary(newEntry) {
    const diary = JSON.parse(localStorage.getItem('diary') || '[]');
    if (!newEntry.dateAdded) {
        newEntry.dateAdded = new Date().toISOString();
    }

    const isSeriesOrAnime = newEntry.Type === 'series' || newEntry.Type === 'anime';
    const isRewatchedMovie = newEntry.Type === 'movie' && newEntry.rewatched;
    const allowDuplicate = isSeriesOrAnime || isRewatchedMovie;

    const isDuplicate = diary.some(entry =>
        entry.imdbID === newEntry.imdbID &&
        entry.Type === newEntry.Type &&
        (!allowDuplicate && entry.dateWatched === newEntry.dateWatched)
    );

    if (!isDuplicate || allowDuplicate) {
        diary.push(newEntry);
        localStorage.setItem('diary', JSON.stringify(diary));
    }
}
function loadDiary() {
    const diary = JSON.parse(localStorage.getItem('diary') || '[]');
    const container = document.getElementById('diary-entries');

    container.innerHTML = '';
    diaryData = {};

    if (diary.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8">Your diary is empty. Start watching!</div>';
        return;
    }

    const sortOrder = document.getElementById('sort-order')?.value || 'desc';
    const filteredDiary = filterDiaryEntries(diary);

    filteredDiary.sort((a, b) => getWatchDate(sortOrder === 'asc' ? a : b) - getWatchDate(sortOrder === 'asc' ? b : a));

    let currentGroup = '';
    const fragments = document.createDocumentFragment();

    filteredDiary.forEach(entry => {
        if (!entry.imdbID || !entry.dateAdded) {
            console.warn('Missing data:', entry);
            return;
        }

        const key = entry.imdbID + entry.dateAdded;
        diaryData[key] = entry;

        const watchDate = getWatchDate(entry);
        const day = watchDate.getDate();
        const monthYear = watchDate.toLocaleString('default', { month: 'long', year: 'numeric' });

        if (monthYear !== currentGroup) {
            currentGroup = monthYear;
            const heading = document.createElement('div');
            heading.className = 'text-white text-xl font-bold mt-6 mb-2';
            heading.textContent = currentGroup.toUpperCase();
            fragments.appendChild(heading);
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'diary-entry-wrapper flex items-center gap-4 px-2 py-3 hover:bg-white/5 rounded transition cursor-pointer min-h-[144px]';
        wrapper.setAttribute('data-imdb-id', entry.imdbID);
        wrapper.setAttribute('data-date-added', entry.dateAdded);
        wrapper.setAttribute('role', 'button');
        wrapper.setAttribute('tabindex', '0');

        let touchStarted = false;
        let touchMoved = false;

        wrapper.addEventListener('touchstart', () => {
            touchStarted = true;
            touchMoved = false;
            wrapper.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        }, { passive: true });

        wrapper.addEventListener('touchmove', () => {
            touchMoved = true;
            wrapper.style.backgroundColor = '';
        }, { passive: true });

        wrapper.addEventListener('touchcancel', () => {
            touchStarted = false;
            wrapper.style.backgroundColor = '';
        });

        wrapper.addEventListener('touchend', (e) => {
            e.preventDefault();
            wrapper.style.backgroundColor = '';
            if (touchStarted && !touchMoved) {
                navigateToReview(entry.imdbID, entry.dateAdded);
            }
            touchStarted = false;
            touchMoved = false;
        });

        wrapper.addEventListener('click', (e) => {
            if (!touchStarted) {
                e.preventDefault();
                e.stopPropagation();
                navigateToReview(entry.imdbID, entry.dateAdded);
            }
        });

        const dateDiv = document.createElement('div');
        dateDiv.className = 'w-10 text-center text-white text-xl font-bold flex-shrink-0';
        dateDiv.textContent = day;
        dateDiv.style.pointerEvents = 'none';

        const posterWrap = document.createElement('div');
        posterWrap.className = 'w-24 h-36 flex-shrink-0';
        posterWrap.style.pointerEvents = 'none';

        const img = document.createElement('img');
        img.src = entry.Poster !== 'N/A' ? entry.Poster : 'https://via.placeholder.com/60x90?text=No+Image';
        img.alt = entry.Title;
        img.className = 'w-full h-full object-cover rounded-md shadow-md bg-black/20';
        img.draggable = false;
        img.loading = 'lazy';
        img.style.pointerEvents = 'none';

        posterWrap.appendChild(img);

        const content = document.createElement('div');
        content.className = 'flex flex-col justify-center min-w-0 text-white';
        content.style.pointerEvents = 'none';

        const title = document.createElement('div');
        title.className = 'text-base font-medium truncate flex items-center gap-1';
        title.innerHTML = `${entry.Title} <span class="text-gray-400 font-light">• ${entry.Year}</span>`;

        // Rewatch icon for movies
        if (entry.Type === 'movie') {
            const sameEntries = filteredDiary.filter(e => e.imdbID === entry.imdbID && e.Type === 'movie');
            const mostRecent = sameEntries[0]?.dateAdded === entry.dateAdded;
            if (sameEntries.length > 1 && mostRecent) {
                const rewatchIcon = document.createElement('span');
                rewatchIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="white" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" class="ml-1">
                        <path d="M3 12a9 9 0 1 0 9-9A9.75 9.75 0 0 0 5.26 5.74L3 8"/><path d="M3 3v5h5"/>
                    </svg>`;
                title.appendChild(rewatchIcon);
            }
        }

        content.appendChild(title);

        // 📺 Series/Anime → show Season then Dates
        if (entry.Type === 'series' || entry.Type === 'anime') {
            if (entry.season) {
                const season = document.createElement('div');
                season.className = 'text-blue-400 text-sm font-normal mt-1';
                season.textContent = `Season ${entry.season}`;
                content.appendChild(season);
            }

            const start = entry.startDate ? new Date(entry.startDate).toLocaleDateString('default', { day: 'numeric', month: 'short'}) : null;
            const finish = entry.finishDate ? new Date(entry.finishDate).toLocaleDateString('default', { day: 'numeric', month: 'short' }) : null;

            if (start && finish) {
    dateText = `
        <div class="flex items-center text-sm text-gray-400 mt-1">
            <span><strong>Finished:</strong> ${start} → ${finish}</span>
        </div>`;
} else if (finish) {
    dateText = `
        <div class="flex items-center text-sm text-gray-400 mt-1">
            <span><strong>Finished:</strong> ${finish}</span>
        </div>`;
} else if (start) {
    dateText = `
        <div class="flex items-center text-sm text-gray-400 mt-1">
            <span><strong>Started:</strong> ${start}</span>
        </div>`;
}


            if (dateText) {
                content.insertAdjacentHTML('beforeend', dateText);
            }
        }

        wrapper.appendChild(dateDiv);
        wrapper.appendChild(posterWrap);
        wrapper.appendChild(content);
        fragments.appendChild(wrapper);

        const hr = document.createElement('hr');
        hr.className = 'border-white/10 mx-2';
        fragments.appendChild(hr);
    });

    container.appendChild(fragments);
}

function navigateToReview(imdbId, dateAdded) {
    if (!imdbId || !dateAdded) return;

    // Delay to allow smooth tap feedback
    setTimeout(() => {
        try {
            openReviewPage(imdbId, dateAdded);
        } catch (error) {
            console.error('Error navigating:', error);
        }
    }, 50);
}

       // Global: Track current page
let lastVisiblePageId = null;

// SPA navigation helpers
function showOnlyPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    const page = document.getElementById(pageId);
    if (page) page.classList.remove('hidden');
}

// Call this to show a page and push it to history
function navigateToPage(pageId) {
    showOnlyPage(pageId);
    history.pushState({ page: pageId }, '', '');
}

// Call this to show a page and replace current history state (no new entry)
function replacePageState(pageId) {
    showOnlyPage(pageId);
    history.replaceState({ page: pageId }, '', '');
}

// --- SPA-aware openReviewPage ---
function openReviewPage(imdbID, dateAdded) {
    const key = imdbID + dateAdded;
    let entry = diaryData[key];

    // 🔁 Fallback: If diaryData is stale, rebuild it from localStorage
    if (!entry) {
        const diary = JSON.parse(localStorage.getItem('diary') || '[]');
        for (const e of diary) {
            const k = e.imdbID + e.dateAdded;
            if (k === key) {
                diaryData[k] = e; // ✅ update cache
                entry = e;
                break;
            }
        }
    }

    if (!entry) {
        alert("Entry not found. It may have been deleted or data is corrupted.");
        return;
    }

    const visiblePage = document.querySelector('.page:not(.hidden)');
    const prevPageId = visiblePage?.id || 'home-page';
    replacePageState(prevPageId);

    showOnlyPage('review-page');
    history.pushState({ page: 'review-page' }, '', '');

    const content = document.getElementById('review-page-content');
    const isSeriesOrAnime = entry.Type === 'series' || entry.Type === 'anime';

    // 🗓️ Format dates
    let dateText = '';
    if (isSeriesOrAnime) {
        const start = entry.startDate ? new Date(entry.startDate).toLocaleDateString() : null;
        const finish = entry.finishDate ? new Date(entry.finishDate).toLocaleDateString() : null;
        if (start && finish) {
            dateText = `<span class="block text-base text-gray-300 mt-1 mb-1">
                <i data-lucide="calendar-days" class="w-4 h-4 inline-block mr-1"></i><strong>Finished:</strong> ${start} → ${finish}</span>`;
        } else if (start) {
            dateText = `<span class="block text-base text-gray-300 mt-1 mb-1">
                <i data-lucide="calendar-days" class="w-4 h-4 inline-block mr-1"></i><strong>Started:</strong> ${start}</span>`;
        } else if (finish) {
            dateText = `<span class="block text-base text-gray-300 mt-1 mb-1">
                <i data-lucide="calendar-days" class="w-4 h-4 inline-block mr-1"></i><strong>Finished:</strong> ${finish}</span>`;
        }
    } else if (entry.dateWatched) {
        dateText = `<span class="block text-base text-gray-300 mt-1 mb-1">
            <i data-lucide="calendar-days" class="w-4 h-4 inline-block mr-1"></i><strong>Watched on:</strong> ${new Date(entry.dateWatched).toLocaleDateString()}</span>`;
    }

    // 📺 Extra Info
    let seasonInfo = '';
    if (entry.Type === 'series' && entry.season) {
        seasonInfo = `<span class="block text-base text-blue-300 font-semibold mb-0.5"><strong>Season:</strong> ${entry.season}</span>`;
    }

    // 🧾 Full content
    content.innerHTML = `
<h2 class="text-2xl font-bold">${entry.Title}</h2>
<p class="text-gray-400">${entry.Year} • ${entry.Type || 'anime'}</p>
${seasonInfo}
${dateText}
${entry.status ? `<p class="text-base text-gray-300"><i data-lucide="bookmark" class="w-4 h-4 inline-block mr-1"></i><strong>Status:</strong> ${entry.status.replace(/-/g, ' ')}</p>` : ''}
${entry.Genre ? `<p class="text-base text-gray-300"><i data-lucide="film" class="w-4 h-4 inline-block mr-1"></i><strong>Genre:</strong> ${entry.Genre}</p>` : ''}
${entry.season && entry.episode ? `<p class="text-base text-gray-300"><i data-lucide="list-video" class="w-4 h-4 inline-block mr-1"></i><strong>Episode:</strong> ${entry.episode}</p>` : ''}
${entry.Type === 'anime' && entry.episodes ? `<p class="text-base text-gray-300"><strong>Total Episodes:</strong> ${entry.episodes}</p>` : ''}

${entry.review
    ? `<div class="pt-4 border-t border-white/10 whitespace-pre-wrap text-base text-gray-200"><i data-lucide="message-square" class="w-4 h-4 inline-block mr-1"></i><strong>Review:</strong><br>${entry.review}</div>` 
    : '<p class="italic text-gray-400">No review available.</p>'}

<div class="pt-4 flex gap-4">
    <button onclick="openEditDiaryModal('${entry.imdbID}', '${entry.dateAdded}')" class="text-sm text-blue-400 underline flex items-center gap-1">
        <i data-lucide="edit-3" class="w-4 h-4"></i> Edit
    </button>
    <button onclick="removeDiaryEntry('${entry.imdbID}', '${entry.dateAdded}')" class="text-sm text-red-400 underline flex items-center gap-1">
        <i data-lucide="trash" class="w-4 h-4"></i> Delete
    </button>
</div>
`;

    lucide.createIcons();
}

// --- SPA-aware back button for review page ---
function goBackFromReview() {
    history.back();
}

// --- SPA popstate handler ---
window.addEventListener('popstate', (event) => {
    // Fallback to home-page if no state or invalid page
    const pageId = event.state?.page || 'home-page';
    showOnlyPage(pageId);
});


        function filterDiary() {
            loadDiary();
        }

        function filterDiaryEntries(diary) {
            const filter = document.getElementById('diary-filter').value;
            if (filter === 'all') return diary;
            return diary.filter(entry => entry.Type === filter || (filter === 'anime' && entry.Type === 'anime'));
        }

        function removeDiaryEntry(id, dateAdded) {
            const confirmed = confirm("Are you sure you want to remove this review?");
            if (!confirmed) return;

            let diary = JSON.parse(localStorage.getItem('diary') || '[]');
            diary = diary.filter(entry => !(entry.imdbID === id && entry.dateAdded === dateAdded));
            localStorage.setItem('diary', JSON.stringify(diary));
            loadDiary();
            updateAllStats();
        }


        // Profile functionality
        function updateProfile() {
            const diary = JSON.parse(localStorage.getItem('diary') || '[]');
            const reviews = diary.filter(e => e.review && e.review.trim() !== '');
            const username = localStorage.getItem('username') || 'Guest';

            const totalMinutes = diary.reduce((sum, e) => sum + (parseInt(e.Runtime) || 0), 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const timeWatched = totalMinutes ? `${hours}h ${minutes}m` : '--';

           

            // Defensive: check elements exist before updating
            const usernameEl = document.getElementById('profile-username');
            if (usernameEl) usernameEl.textContent = username;
            const entriesEl = document.getElementById('profile-total-entries');
            if (entriesEl) entriesEl.textContent = diary.length;
            const reviewsEl = document.getElementById('profile-total-reviews');
            if (reviewsEl) reviewsEl.textContent = reviews.length;
            const timeEl = document.getElementById('profile-time-watched');
            if (timeEl) timeEl.textContent = timeWatched;

            const badgeContainer = document.getElementById('profile-badges');
            if (badgeContainer) badgeContainer.innerHTML = badges.map(b => `<span class="bg-white/10 px-2 py-1 rounded text-sm">${b}</span>`).join('');

            // Avatar restore logic
            const avatar = localStorage.getItem('avatar');
            const avatarImg = document.getElementById('profile-avatar');
            if (avatar && avatarImg) avatarImg.src = avatar;
            else if (avatarImg) avatarImg.src = 'https://i.imgur.com/1XjXgJL.png';

            // Update watched stats
            updateProfileWatchedStats();
        }

        // Add this function to update profile stats for watched this month/last month/this year/last year
        function updateProfileWatchedStats() {
            const diary = JSON.parse(localStorage.getItem('diary') || '[]');
            const now = new Date();
            const thisYear = now.getFullYear();
            const monthStart = new Date(thisYear, now.getMonth(), 1);
            const firstOfLastMonth = new Date(thisYear, now.getMonth() - 1, 1);
            const lastOfLastMonth = new Date(thisYear, now.getMonth(), 0, 23, 59, 59, 999);

            const thisMonthCount = diary.filter(entry => {
                if (!entry.dateWatched) return false;
                return new Date(entry.dateWatched) >= monthStart;
            }).length;
            const lastMonthCount = diary.filter(entry => {
                if (!entry.dateWatched) return false;
                const d = new Date(entry.dateWatched);
                return d >= firstOfLastMonth && d <= lastOfLastMonth;
            }).length;
            const thisYearCount = diary.filter(entry => {
                if (!entry.dateWatched) return false;
                const d = new Date(entry.dateWatched);
                return d.getFullYear() === thisYear;
            }).length;
            const lastYear = thisYear - 1;
            const lastYearCount = diary.filter(entry => {
                if (!entry.dateWatched) return false;
                const d = new Date(entry.dateWatched);
                return d.getFullYear() === lastYear;
            }).length;

            // Update profile page stats
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            set('profile-this-month', thisMonthCount);
            set('profile-last-month', lastMonthCount);
            set('profile-this-year', thisYearCount);
            set('profile-last-year', lastYearCount);
        }

        // Username edit modal logic (single version)
        function toggleUsernameEdit() {
            const box = document.getElementById('username-edit-box');
            box.classList.toggle('hidden');
            setTimeout(() => {
                box.classList.toggle('show', !box.classList.contains('hidden'));
            }, 10);
            const current = localStorage.getItem('username') || 'Guest';
            document.getElementById('username-input').value = current;
        }
        function saveUsername() {
            const name = document.getElementById('username-input').value.trim();
            if (name) {
                localStorage.setItem('username', name);
                updateProfile();
                document.getElementById('username-edit-box').classList.add('hidden');
            }
        }
        // Hide username box when clicking outside
        document.addEventListener('click', function (e) {
            const box = document.getElementById('username-edit-box');
            const trigger = document.getElementById('profile-username');
            if (box.classList.contains('show') && !box.contains(e.target) && e.target !== trigger) {
                box.classList.remove('show');
                setTimeout(() => box.classList.add('hidden'), 300);
            }
        });
        // Avatar upload
        document.getElementById('avatar-upload').addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const avatarData = e.target.result;
                    localStorage.setItem('avatar', avatarData);
                    document.getElementById('profile-avatar').src = avatarData;
                };
                reader.readAsDataURL(file);
            }
        });
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('✅ Service Worker registered:', reg.scope))
                    .catch(err => console.error('❌ Service Worker registration failed:', err));
            });
        }
        function showToast(message) {
            const toast = document.getElementById('toast-msg');
            toast.textContent = message;

            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');

            // Auto-hide after 2.5 seconds
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 2000);
        }
function goBackFromReview() {
    history.back(); // This will trigger the popstate event
}

        // Edit diary modal logic
        function updateEditStars() {
            document.querySelectorAll('#edit-rating-stars .edit-star').forEach((star, index) => {
                star.classList.toggle('filled', index < editRating);
            });
        }

        // Add this function to open the edit diary modal and populate fields
function openEditDiaryModal(imdbID, dateAdded) {
      const diary = JSON.parse(localStorage.getItem('diary') || '[]');
      const entry = diary.find(e => e.imdbID === imdbID && e.dateAdded === dateAdded);
      if (!entry) return;

      editingEntryId = imdbID;
      editingEntryTimestamp = dateAdded;

      const isSeriesOrAnime = entry.Type === 'series' || entry.Type === 'anime';

      document.getElementById('edit-review-text').value = entry.review || '';
      document.getElementById('edit-watch-status').value = entry.status || 'completed';

      document.getElementById('edit-season-number').value = entry.season || '';
      document.getElementById('edit-episode-number').value = entry.episode || '';

      // Show/hide correct date fields
      document.getElementById('edit-date-range').classList.toggle('hidden', !isSeriesOrAnime);
      document.getElementById('edit-date-single').classList.toggle('hidden', isSeriesOrAnime);

      document.getElementById('edit-watch-date').value = entry.dateWatched || '';
      document.getElementById('edit-start-date').value = entry.startDate || '';
      document.getElementById('edit-finish-date').value = entry.finishDate || '';
      // Set and update star rating
      editRating = entry.rating || 0;
      updateEditStars();
      document.getElementById('edit-diary-modal').classList.add('active');

      // Attach event listeners to edit stars every time modal opens
      document.querySelectorAll('#edit-rating-stars .edit-star').forEach(star => {
        star.onclick = function () {
          editRating = parseInt(this.dataset.rating);
          updateEditStars();
        };
      });
    }

    function clearEditRating() {
      editRating = 0;
      updateEditStars();
    }

    function closeEditModal() {
      editingEntryId = null;
      editingEntryTimestamp = null;
      document.getElementById('edit-diary-modal').classList.remove('active');
    }

    function saveEditedEntry() {
      const diary = JSON.parse(localStorage.getItem('diary') || '[]');
      const index = diary.findIndex(e =>
        e.imdbID === editingEntryId && e.dateAdded === editingEntryTimestamp
      );
      if (index === -1) return;

      const entry = diary[index];
      const isSeriesOrAnime = entry.Type === 'series' || entry.Type === 'anime';

      diary[index].review = document.getElementById('edit-review-text').value || null;
      diary[index].status = document.getElementById('edit-watch-status').value || 'completed';
      diary[index].season = parseInt(document.getElementById('edit-season-number').value) || null;
      diary[index].episode = parseInt(document.getElementById('edit-episode-number').value) || null;
      diary[index].rating = editRating;

      // Dates
      diary[index].dateWatched = isSeriesOrAnime ? null : document.getElementById('edit-watch-date').value || null;
      diary[index].startDate = isSeriesOrAnime ? document.getElementById('edit-start-date').value || null : null;
      diary[index].finishDate = isSeriesOrAnime ? document.getElementById('edit-finish-date').value || null : null;
      const key = diary[index].imdbID + diary[index].dateAdded;
      diaryData[key] = diary[index]; // Update in-memory cache
      // If currently on the review page, re-render it
      const isReviewPageVisible = !document.getElementById('review-page').classList.contains('hidden');
      if (isReviewPageVisible) {
        openReviewPage(diary[index].imdbID, diary[index].dateAdded);
      }

      localStorage.setItem('diary', JSON.stringify(diary));

      closeEditModal();
      loadDiary();
      updateAllStats();
      updateProfile();

      showToast("Entry updated ✅");
    }

window.addEventListener('popstate', (event) => {
    // Hide all pages
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));

    // Show the page from the history state, fallback to home-page
    const pageId = event.state?.page || 'home-page';
    document.getElementById(pageId)?.classList.remove('hidden');
});


    </script>
    <!-- Edit Diary Modal -->
    <div id="edit-diary-modal" class="modal fixed inset-0 bg-black/80 items-center justify-center z-50 p-4 hidden">
        <div class="glass rounded-xl max-w-md w-full">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-6 gradient-text">Edit Entry</h3>

                <!-- Review -->
                <textarea id="edit-review-text" rows="3" placeholder="Edit your review"
                    class="w-full p-3 bg-dark-800 border border-white/20 rounded-lg text-white mb-4 resize-none"></textarea>

                <!-- Status -->
                <div class="mb-4">
                    <label for="edit-watch-status" class="text-sm mb-1 text-white/80 block">Status</label>
                    <select id="edit-watch-status"
                        class="p-3 bg-dark-800 border border-white/20 rounded-lg text-white w-full">
                        <option value="watching">Watching</option>
                        <option value="completed">Completed</option>
                        <option value="on-hold">On-Hold</option>
                        <option value="dropped">Dropped</option>
                        <option value="plan-to-watch">Plan to Watch</option>
                        <option value="rewatch">Rewatch</option>
                    </select>
                </div>



                <!-- Start + Finish (for series/anime) -->
                <div id="edit-date-range" class="grid grid-cols-2 gap-4 mb-4 hidden">
                    <div class="flex flex-col">
                        <label for="edit-start-date" class="text-sm mb-1 text-white/80">Start Date</label>
                        <input type="date" id="edit-start-date"
                            class="p-3 bg-dark-800 border border-white/20 rounded-lg text-white">
                    </div>
                    <div class="flex flex-col">
                        <label for="edit-finish-date" class="text-sm mb-1 text-white/80">Finished On</label>
                        <input type="date" id="edit-finish-date"
                            class="p-3 bg-dark-800 border border-white/20 rounded-lg text-white">
                    </div>
                </div>

                <!-- Watched On (for movies) -->
                <div id="edit-date-single" class="mb-4">
                    <label for="edit-watch-date" class="text-sm mb-1 text-white/80">Watched On</label>
                    <input type="date" id="edit-watch-date"
                        class="w-full p-3 bg-dark-800 border border-white/20 rounded-lg text-white">
                </div>

                <!-- Season / Episode -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input type="number" id="edit-season-number" placeholder="Season"
                        class="p-3 bg-dark-800 border border-white/20 rounded-lg text-white">
                    <input type="number" id="edit-episode-number" placeholder="Episode"
                        class="p-3 bg-dark-800 border border-white/20 rounded-lg text-white">
                </div>

                <!-- Actions -->
                <div class="flex justify-between gap-3">
                    <button onclick="saveEditedEntry()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex-1">
                        Save
                    </button>
                    <button onclick="closeEditModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Review Modal -->
    <div id="review-page" class="page hidden p-4 max-w-2xl mx-auto text-white">
        <button onclick="goBackFromReview()" class="text-blue-400 hover:underline mb-4 flex items-center gap-1">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
        </button>
        <div id="review-page-content" class="space-y-4">
            <!-- Populated by JS -->
        </div>
    </div>


    <!-- Toast Message -->
    <div id="toast-msg"
        class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-all duration-500 z-50 text-sm">
        Added to diary
    </div>

    <script>
        lucide.createIcons();
    </script>


</body>


</html>
